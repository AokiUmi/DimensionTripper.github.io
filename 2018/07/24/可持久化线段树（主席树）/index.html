<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.5.2 -->
    <script>
        window.materialVersion = "1.5.2"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1',
            '1.5.0'
        ]
    </script>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">














    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!-- Title -->
    
    <title>
        
            可持久化线段树（主席树） | 
        
        DimensionTripper
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" href="/img/favicon.png">

    <meta name="format-detection" content="telephone=no"/>
    <meta name="description" itemprop="description" content="">
    <meta name="keywords" content=",数据结构,主席树">
    <meta name="theme-color" content="#0097A7">

    <!-- Disable Fucking Bloody Baidu Tranformation -->
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(a){try{localStorage.removeItem(a)}catch(b){}};lsloader.setLS=function(a,c){try{localStorage.setItem(a,c)}catch(b){}};lsloader.getLS=function(a){var c="";try{c=localStorage.getItem(a)}catch(b){c=""}return c};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var b=[];for(var a=0;a<localStorage.length;a++){b.push(localStorage.key(a))}b.forEach(function(e){var f=lsloader.getLS(e);if(window.oldVersion){var d=window.oldVersion.reduce(function(g,h){return g||f.indexOf("/*"+h+"*/")!==-1},false);if(d){lsloader.removeLS(e)}}})}catch(c){}};lsloader.clean();lsloader.load=function(f,a,b,d){if(typeof b==="boolean"){d=b;b=undefined}d=d||false;b=b||function(){};var e;e=this.getLS(f);if(e&&e.indexOf(versionString)===-1){this.removeLS(f);this.requestResource(f,a,b,d);return}if(e){var c=e.split(versionString)[0];if(c!=a){console.log("reload:"+a);this.removeLS(f);this.requestResource(f,a,b,d);return}e=e.split(versionString)[1];if(d){this.jsRunSequence.push({name:f,code:e});this.runjs(a,f,e)}else{document.getElementById(f).appendChild(document.createTextNode(e));b()}}else{this.requestResource(f,a,b,d)}};lsloader.requestResource=function(b,e,a,c){var d=this;if(c){this.iojs(e,b,function(h,f,g){d.setLS(f,h+versionString+g);d.runjs(h,f,g)})}else{this.iocss(e,b,function(f){document.getElementById(b).appendChild(document.createTextNode(f));d.setLS(b,e+versionString+f)},a)}};lsloader.iojs=function(d,b,g){var a=this;a.jsRunSequence.push({name:b,code:""});try{var f=new XMLHttpRequest();f.open("get",d,true);f.onreadystatechange=function(){if(f.readyState==4){if((f.status>=200&&f.status<300)||f.status==304){if(f.response!=""){g(d,b,f.response);return}}a.jsfallback(d,b)}};f.send(null)}catch(c){a.jsfallback(d,b)}};lsloader.iocss=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.iofonts=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.runjs=function(f,c,e){if(!!c&&!!e){for(var b in this.jsRunSequence){if(this.jsRunSequence[b].name==c){this.jsRunSequence[b].code=e}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var a=document.createElement("script");a.appendChild(document.createTextNode(this.jsRunSequence[0].code));a.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(a);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else{if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var d=this;var a=document.createElement("script");a.src=this.jsRunSequence[0].path;a.type="text/javascript";this.jsRunSequence[0].status="loading";a.onload=function(){d.jsRunSequence.shift();if(d.jsRunSequence.length>0){d.runjs()}};document.body.appendChild(a)}}};lsloader.tagLoad=function(b,a){this.jsRunSequence.push({name:a,code:"",path:b,status:"failed"});this.runjs()};lsloader.jsfallback=function(c,b){if(!!this.jsnamemap[b]){return}else{this.jsnamemap[b]=b}for(var a in this.jsRunSequence){if(this.jsRunSequence[a].name==b){this.jsRunSequence[a].code="";this.jsRunSequence[a].status="failed";this.jsRunSequence[a].path=c}}this.runjs()};lsloader.cssfallback=function(e,c,b){if(!!this.cssnamemap[c]){return}else{this.cssnamemap[c]=1}var d=document.createElement("link");d.type="text/css";d.href=e;d.rel="stylesheet";d.onload=d.onerror=b;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(d,a)};lsloader.runInlineScript=function(c,b){var a=document.getElementById(b).innerText;this.jsRunSequence.push({name:c,code:a});this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","/css/material.min.css?Z7a72R1E4SxzBKR/WGctOA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","/css/style.min.css?MKetZV3cUTfDxvMffaOezg==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        
            
                <style id="prettify_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("prettify_css","/css/prettify.min.css?zp8STOU9v89XWFEnN+6YmQ==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
                <style id="prettify_theme"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("prettify_theme","/css/prettify/github-v2.min.css?AfzKxt++K+/lhZBlSjnxwg==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
            
        

    

    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0080FF !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0080FF !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0080FF !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-image: url(http://b244.photo.store.qq.com/psb?/V137oTmC2F4y9l/r4Rxh8RhBW1V31QIlHMRgJiPHzQPRoCy2G76azhbCeU!/c/dPQAAAAAAAAA&amp;bo=gAc4BIAHOAQRADc!);
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">


<!-- Import Material Icons -->


    <style id="material_icons"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_icons","/css/material-icons.css?pqhB/Rd/ab0H2+kZp0RDmw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==", true)</script>
    

    <!-- WebAPP Icons -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="DimensionTripper">
    <meta name="msapplication-starturl" content="http://yoursite.com/2018/07/24/可持久化线段树（主席树）/">
    <meta name="msapplication-navbutton-color" content="#0097A7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="DimensionTripper">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!-- Site Verification -->
    
    

    <!-- RSS -->
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://yoursite.com/2018/07/24/可持久化线段树（主席树）/">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="可持久化线段树（主席树） | DimensionTripper">
    <meta property="og:image" content="/img/favicon.png">
    <meta property="og:description" content="">
    <meta property="og:article:tag" content="数据结构"> <meta property="og:article:tag" content="主席树"> 

    
        <meta property="article:published_time" content="Tue Jul 24 2018 09:28:04 GMT+0800">
        <meta property="article:modified_time" content="Tue Jul 24 2018 09:30:13 GMT+0800">
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:card" content="summary_large_image">

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://yoursite.com/2018/07/24/可持久化线段树（主席树）/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "http://yoursite.com/2018/07/24/可持久化线段树（主席树）/index.html",
    "headline": "可持久化线段树（主席树）",
    "datePublished": "Tue Jul 24 2018 09:28:04 GMT+0800",
    "dateModified": "Tue Jul 24 2018 09:30:13 GMT+0800",
    "author": {
        "@type": "Person",
        "name": "DimensionTripper",
        "image": {
            "@type": "ImageObject",
            "url": "https://cdn.luogu.org/upload/usericon/55454.png"
        },
        "description": "自己选择的路，跪着也要走完"
    },
    "publisher": {
        "@type": "Organization",
        "name": "DimensionTripper",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/favicon.png"
        }
    },
    "keywords": ",数据结构,主席树",
    "description": "",
}
</script>


    

    <!-- Analytics -->
    
    
    

    <!-- Custom Head --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    

</head>


    
        <body id="scheme-Paradox" class="lazy">
            <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->


    <!-- Left aligned menu below button -->
    
    
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#不支持修改"><span class="post-toc-number">1.</span> <span class="post-toc-text">不支持修改</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#以下是瞎扯"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">以下是瞎扯</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#带修改（主席树-树状数组）"><span class="post-toc-number">2.</span> <span class="post-toc-text">带修改（主席树+树状数组）</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#例题"><span class="post-toc-number">3.</span> <span class="post-toc-text">例题</span></a></li></ol>
    </ul>
    




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                可持久化线段树（主席树）
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="https://cdn.luogu.org/upload/usericon/55454.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>DimensionTripper</strong>
        <span>7月 24, 2018</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/主席树/">主席树</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/数据结构/">数据结构</a>
    </ul>
    

    <!-- Share -->
    
        <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=可持久化线段树（主席树）&url=http://yoursite.com/2018/07/24/可持久化线段树（主席树）/index.html&pic=http://yoursite.com/img/favicon.png&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=可持久化线段树（主席树）&url=http://yoursite.com/2018/07/24/可持久化线段树（主席树）/index.html&via=DimensionTripper" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2018/07/24/可持久化线段树（主席树）/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://yoursite.com/2018/07/24/可持久化线段树（主席树）/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    
        <a class="post_share-link" href="http://connect.qq.com/widget/shareqq/index.html?site=DimensionTripper&title=可持久化线段树（主席树）&summary=&pics=http://yoursite.com/img/favicon.png&url=http://yoursite.com/2018/07/24/可持久化线段树（主席树）/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 QQ
            </li>
        </a>
    

    <!-- Share Telegram -->
    
</ul>

    
</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h1 id="不支持修改"><a href="#不支持修改" class="headerlink" title="不支持修改"></a>不支持修改</h1><p>读以下文字时最好有些线段树的预备知识，毕竟根据发明者的原话：“想法是对原序列的每一个前缀[1..i]建立出一颗线段树维护值域上每个数的出现次数，然后发现这样的树是可以减的，然后就没有然后了”</p>
<p>主席树可以用来解决如下问题：“给出一列数,a1,a2…an,每次询问其中连续的一段区间ai到aj其中的第K大的数是多少？”</p>
<p>建那么多的线段树显然会MLE！！但是为了便于理解，这里先把这个岔放下。我们先新开一个数组t[n]，其中存着an排序并去重的值。</p>
<p>那么每棵线段树维护的内容是什么呢？是a1到ai这段区间中的数在t[n]中出现的次数。这段话的内容也许有点抽象，举个例子 </p>
<p>an：4 1 1 2 8 9 4 4 3</p>
<p>排序并去重后得到{tn}</p>
<p>tn：1 2 3 4 8 9</p>
<p>下面对前缀a[1..9]建树，它有两个1,一个2,一个3，三个4，一个8和一个9，那么它的出现次数便是线段树维护的值（为表示清楚记为Cn）建树完后如下图，树中每个节点的值表示t[i,j]中的数字在a[1..9]中出现的次数和，i，j即为节点下面标出的区间。</p>
<p><img src="http://a3.qpic.cn/psb?/V137oTmC2F4y9l/2S3fUDKdnVKID0gupBH2P.rYvp02fQ93VsDePDGXLRY!/m/dCIBAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=0wFRAdMBUQEBACc!&amp;vuin=1013006824&amp;tm=1520676000&amp;sce=60-4-3&amp;rf=0-0" alt=""></p>
<p>下面我们来看对于这棵树如何求第K大值。比如我们求a[1..9]中第6大的数是多少？我们看到根节点的左儿子只有4个元素，那么第6大数一定在右儿子中，并且我们可以把问题递归下去即求区间t[4,6]的三个数中为a[1..9]去除所有数字为t[1],t[2],t[3]后第2大的数是多少。（c[1]+c[2]+c[3]=4，那么6-4=2）。我们看到此时的左儿子（区间t[4,5]）有4个元素，4&gt;2,因此第二大数一定在左儿子中，递归进入左儿子，此时即求区间t[4,5]的两个数中为a[1..9]去除所有数字为t[1],t[2],t[3],t[6]后第2大的数是多少。最后区间[4,4]有三个元素，3&gt;2，所以第二大数一定在区间[4,4]里即t[4]=4，所以a[1..9]中第6大数为4。</p>
<p>这里要记住的是对于每个i , a[1,i]都有一棵树，求a[L,R]的第K大与求a[1,R]的类似，只要在每层递归时减去a[1，L-1]所在树的相应部分即可，比如在a[L,R]，小于t[mid]的数有6个，在a[1,L-1] 小于t[mid]的数有2个，那么在a[L,R] 小于t[mid]的数就有6-2=4个，递归过程和上面类似，不再详细展开。</p>
<p>下面解决MLE这个梗。如下图画出a1…5到9为前缀的树，然后发现树的形态都非常像！！</p>
<p>例子 </p>
<p>an：4 1 1 2 8 9 4 4 3</p>
<p>排序并去重后得到{tn}</p>
<p>tn：1 2 3 4 8 9</p>
<p> <img src="http://a3.qpic.cn/psb?/V137oTmC2F4y9l/2S3fUDKdnVKID0gupBH2P.rYvp02fQ93VsDePDGXLRY!/m/dCIBAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=0wFRAdMBUQEBACc!&amp;vuin=1013006824&amp;tm=1520676000&amp;sce=60-4-3&amp;rf=0-0" alt=""></p>
<p> <img src="http://a3.qpic.cn/psb?/V137oTmC2F4y9l/AnbpwRjcYkCKVoDZhnI4H38uJ1bnNO690XauRZmZ5t0!/m/dCIBAAAAAAAA&amp;ek=1&amp;kp=1&amp;pt=0&amp;bo=2wFsAdsBbAEBACc!&amp;vuin=1013006824&amp;tm=1520676000&amp;sce=60-4-3&amp;rf=0-0" alt=""></p>
<p><img src="http://b289.photo.store.qq.com/psb?/V137oTmC2F4y9l/a7IbaB.7jbVJfyDC6mBSH3JC1QXxu1ClfFQEn2vF9KA!/c/dCEBAAAAAAAA&amp;bo=0wFRAdMBUQEBACc!&amp;rf=mood_app" alt=""></p>
<p><img src="http://b289.photo.store.qq.com/psb?/V137oTmC2F4y9l/EOvrw6WLtcyvuNHLSBzUYTiYDtTyTpZTd6lM9IVDFJY!/c/dCEBAAAAAAAA&amp;bo=0wFRAdMBUQEBACc!&amp;rf=mood_app" alt=""></p>
<p>这是我们能够压缩的空间。例如以a[1..9]为前缀建的树的右子树与以a[1..8]为前缀建的树的右子树是相同的！！因此在建树a[1..9]的时候（建树是从1到9的顺序）根节点可以直接向a[1..8]的右子树连一条边。同理，对于根节点的左儿子来说（现在把这个点看做根节点），它的左子树和a[1..8]的相应部分也是相同的，因此也连一条边，如下图所示</p>
<p> <img src="http://b290.photo.store.qq.com/psb?/V137oTmC2F4y9l/1dG0ZdwBCVWhD.OSkmHQMKFOrQJIPIpz.BAOfgBD8ss!/c/dCIBAAAAAAAA&amp;bo=9wDTAPcA0wABACc!&amp;rf=mood_app" alt=""></p>
<p>这样我们只增加了三个点却保存了两棵树的所有信息！！像这样在前面树的基础上建树，我们只需要开一个数组储存图示两个箭头所指的根的位置就够了，顺着根向下遍历便是如前所述一棵完整的线段树</p>
<hr>
<h2 id="以下是瞎扯"><a href="#以下是瞎扯" class="headerlink" title="以下是瞎扯"></a>以下是瞎扯</h2><p>首先我们来了解什么叫做主席树，下面是从其他大佬的博客中复制过来的了解一下就行</p>
<p>所谓主席树呢，就是对原来的数列[1..n]的每一个前缀[1..i]（1≤i≤n）建立一棵线段树，线段树的每一个节点存某个前缀[1..i]中属于区间[L..R]的数一共有多少个（比如根节点是[1..n]，一共i个数，sum[root] = i；根节点的左儿子是[1..(L+R)/2]，若不大于(L+R)/2的数有x个，那么sum[root.left] = x）。若要查找[i..j]中第k大数时，设某结点x，那么x.sum[j] - x.sum[i - 1]就是[i..j]中在结点x内的数字总数。而对每一个前缀都建一棵树，会MLE，观察到每个[1..i]和[1..i-1]只有一条路是不一样的，那么其他的结点只要用回前一棵树的结点即可，时空复杂度为O(nlogn)。</p>
<hr>
<p>看了什么的介绍，感觉并没有什么卵用，还是一脸懵逼，下面我一点一点来讲解主席树的原理以及实现过程和代码。</p>
<p>在学习主席树之前，需要你很熟悉线段树这个东西，因为主席树的主体是多颗线段树，首先我们来简单的回顾一下线段树的简单特点和性质，我们熟悉的线段树一般是用一个结构体表示一个节点，每个节点有一个编号，节点里面一般有两个变量l, r来表示这个节点维护的区间，然后还有一个区间信息（比如区间最大值，最小值，和等，视具体问题而定），当然如果涉及到区间更新，还有一个add或者lazy叫做延迟标记的东西，然后一般线段树最明显的特点就行，一个父节点的编号是i,那么他的两只儿子节点的编号分别为2 <em> i(左） , 2 </em> i + 1（右），注意主席树在这一点有别于一般的线段树，每一个父节点，他的两个儿子节点的编号不一定满足这个关系。</p>
<p>我们先来分析一下对于任意一个区间，我们怎样求解这个区间的第k小值，当然一个最简单的做法就是把这个区间的数都拿出来排个序，然后直接输出就好，这很简单，但是复杂度爆表，我们考虑一个线段树的做法，假如一个区间l, r我们用一个用这个区间内出现过的数的个数组成一颗线段树，这是什么意思呢，求一个区间的第k小数，当然与这个区间有多少数比他小有关，在这里我举一个例子来说明一下怎样建立这样的一颗线段树。比如这个区间表示的序列是4，1，3，2，我们要求第2小，我们一眼就看出是2，那么我们怎样上面所说的线段树来求解呢，下面我画了一幅图来讲解，其中这颗线段树上的每个节点维护的是这个节点表示区间内的个数（假设每个数都不一样）</p>
<p> <img src="http://b247.photo.store.qq.com/psb?/V137oTmC2F4y9l/ca0YRv9fRBOPR7nmbKhIbHOCb*RSMmykiARFerbHLgc!/c/dPcAAAAAAAAA&amp;bo=QQLaAUEC2gEBACc!&amp;rf=mood_app" alt=""></p>
<p>圈内的数字表示这个区间里面有多少个数，最后叶节点表示一个数字，对应上述序列中的一个数，注意，任意一个长度为N的序列我们都可以把他离散为一个1 ，2，3，，，，N的序列，只需要简单的hash一下就行。然后这样的一颗线段树建立出来了，我们怎样寻找区间第2小，因为叶节点从左到右表示的数依次增大，根据这个性质，以及每个节点保存了区间内的数的个数这个信息，我们可以轻易的找出区间第2小，具体的找法是，从根节点开始，看左儿子里面的数的 个数是不是大于等于2，如果是则第2小一定在左子树中，于是继续找左子树，反之找右子树，直到找到叶节点为止，然后直接返回叶节点表示的值就行。</p>
<p>但是多次询问区间第k小，我们每次这样建立一个线段树，这样不仅空间复杂度非常之高，而且时间复杂度也非常高，甚至比普通排序还要高，那么我们只不是可以想一个办法，使得对于每次我们查询不同的区间我们不需要重新建树，如果这样。时间复杂度和空间复杂度就大大降低了。</p>
<p>我们很容易就联想到了前缀和的概念，比如我们有一个问题。就是每次静态的求区间和，我们可以预处理所以的前缀和sum[i]，我们每次求解区间l, r和时，我们可以直接得到答案为sum[r] - sum[l -1],这样就不需要对区间中的每个数进行相加来求解了。</p>
<p>同样一个道理，我们也可以利用前缀和这个思想来解决建树这个问题，我们只需要建立n颗“前缀”线段树就行，第i树维护[1,i]序列，这样我们处理任意区间l, r时就可以通过处理区间[1,l - 1], [1,r]，就行，然后两者的处理结果进行相加相减就行。为什么满足相加减的性质，我们简单分析一下就很容易得出。如果在区间[1,l - 1]中有x个数小于一个数，在[1,r]中有y个数小于那个数，那么在区间[l,r]中就有y - x 个数小于那个数了，这样就很好理解为什么可以相加减了，另外，每颗树的结构都一样，都是一颗叶节点为n个的线段树。</p>
<p>上述利用前缀和的思想只是解决了时间复杂度的问题，并没有解决空间复杂度的问题，要解决空间复杂度问题。我们需要用到线段树的性质，我们每次更新一个数，那么与更新之前相比，这颗线段树改变只是一条链（从根节点到某一叶节点），那么我们可以充分利用这个特点，因为第i颗树与第i- 1颗树相比，只是更新了第i个元素，所以这两棵树有很多相同的节点，所以这两棵树可以共用很多节点（这也是为什么主席树的中节点编号不满足儿子节点编号是父节点编号的两倍和两倍加一的原因），于是这样就解决空间复杂度问题。</p>
<p><a href="https://www.luogu.org/problemnew/show/P3919" target="_blank" rel="noopener"> P3919 【模板】可持久化数组（可持久化线段树/平衡树）</a></p>
<p>手写AC（O2-1016ms）</p>
<pre><code class="cpp">#include &lt;bits/stdc++.h&gt;
#define N 200000+110
using namespace std;
int a[N],Hash[N],t[N],tot,n,m;
int sum[50*N],L[50*N],R[50*N];
int build(int l,int r)
{
    int rt=++tot;
    sum[rt]=0;
    if(l&lt;r)
    {
        int m=(l+r)/2;
        L[rt]=build(l,m);
        R[rt]=build(m+1,r);
    }
    return rt;
}
int update(int pre,int l,int r,int x)
{
    int rt=++tot;
    L[rt]=L[pre];
    R[rt]=R[pre];
    sum[rt]=sum[pre]+1;
    if(l&lt;r)
    {
        int m=(l+r)/2;
        if(x&lt;=m)
            L[rt]=update(L[pre],l,m,x);
        else
            R[rt]=update(R[pre],m+1,r,x);
    }
    return rt;
}
int query(int u,int v,int l,int r,int k)
{
    if(l==r)
        return l;
    int num=sum[L[v]]-sum[L[u]];
    int m=(l+r)/2;
    if(num&gt;=k)
        return query(L[u],L[v],l,m,k);
    else
        return query(R[u],R[v],m+1,r,k-num);
}
int main()
{
    scanf(&quot;%d%d&quot;,&amp;n,&amp;m);
    for(int i=1;i&lt;=n;i++)
    {
        scanf(&quot;%d&quot;,&amp;a[i]);
        Hash[i]=a[i];
    }
    sort(Hash+1,Hash+1+n);
    int d=unique(Hash+1,Hash+1+n)-Hash-1;
    t[0]=build(1,d);
    for(int i=1;i&lt;=n;i++)
    {
        int x=lower_bound(Hash+1,Hash+1+d,a[i])-Hash;
        t[i]=update(t[i-1],1,d,x);
    }
    for(int i=1;i&lt;=m;i++)
    {
        int l,r,k;
        scanf(&quot;%d%d%d&quot;,&amp;l,&amp;r,&amp;k);
        int x=query(t[l-1],t[r],1,d,k);
        printf(&quot;%d\n&quot;,Hash[x]);
    }
    return 0;
}
</code></pre>
<p><a href="https://www.luogu.org/problemnew/show/P3567" target="_blank" rel="noopener">P3567 [POI2014]KUR-Couriers</a></p>
<p>手写AC（O2-1032ms）</p>
<pre><code class="cpp">#include &lt;bits/stdc++.h&gt;
#define N 500000+110
using namespace std;
int a[N],Hash[N],t[N],tot,n,m;
int sum[50*N],L[50*N],R[50*N];
int build(int l,int r)
{
    int rt=++tot;
    sum[rt]=0;
    if(l&lt;r)
    {
        int m=(l+r)/2;
        L[rt]=build(l,m);
        R[rt]=build(m+1,r);
    }
    return rt;
}
int update(int pre,int l,int r,int x)
{
    int rt=++tot;
    L[rt]=L[pre];
    R[rt]=R[pre];
    sum[rt]=sum[pre]+1;
    if(l&lt;r)
    {
        int m=(l+r)/2;
        if(x&lt;=m)
            L[rt]=update(L[pre],l,m,x);
        else
            R[rt]=update(R[pre],m+1,r,x);
    }
    return rt;
}
int query(int u,int v,int l,int r,int k)
{
    if(l==r)
        return l;
    int num=sum[L[v]]-sum[L[u]];
    int num1=sum[R[v]]-sum[R[u]];
    int m=(l+r)/2;
    if(num&gt;=k)
        return query(L[u],L[v],l,m,k);
    else if(num1&gt;=k)
        return query(R[u],R[v],m+1,r,k);
    else
        return 0;
}
int main()
{
    scanf(&quot;%d%d&quot;,&amp;n,&amp;m);
    for(int i=1;i&lt;=n;i++)
    {
        scanf(&quot;%d&quot;,&amp;a[i]);
        Hash[i]=a[i];
    }
    sort(Hash+1,Hash+1+n);
    int d=unique(Hash+1,Hash+1+n)-Hash-1;
    t[0]=build(1,d);
    for(int i=1;i&lt;=n;i++)
    {
        int x=lower_bound(Hash+1,Hash+1+d,a[i])-Hash;
        t[i]=update(t[i-1],1,d,x);
    }
    for(int i=1;i&lt;=m;i++)
    {
        int l,r,k;
        scanf(&quot;%d%d&quot;,&amp;l,&amp;r);
        k=(r-l+1)/2+1;
        int x=query(t[l-1],t[r],1,d,k);
        printf(&quot;%d\n&quot;,Hash[x]);
    }
    return 0;
}
</code></pre>
<p><a href="http://acm.hdu.edu.cn/showproblem.php?pid=4417" target="_blank" rel="noopener">HDU 4417 Super Mario</a></p>
<p>纯手写AC（140ms）</p>
<pre><code class="cpp">#include &lt;bits/stdc++.h&gt;
#define N 500000+110
#define inf 2147483647
using namespace std;
int a[N],Hash[N];
int sum[50*N],L[50*N],R[50*N],t[N],tot,n,m;
int build(int l,int r)
{
    int rt=++tot;
    sum[rt]=0;
    if(l&lt;r)
    {
        int m=(l+r)/2;
        L[rt]=build(l,m);
        R[rt]=build(m+1,r);
    }
    return rt;
}
int update(int pre,int l,int r,int x)
{
    int rt=++tot;
    L[rt]=L[pre];
    R[rt]=R[pre];
    sum[rt]=sum[pre]+1;
    if(l&lt;r)
    {
        int m=(l+r)/2;
        if(x&lt;=m)
            L[rt]=update(L[pre],l,m,x);
        else
            R[rt]=update(R[pre],m+1,r,x);
    }
    return rt;
}
int query(int u,int v,int l,int r,int k)
{
    if(l==r)
        return sum[v]-sum[u];
    int b=0;
    int m=(l+r)/2;
    if(k&gt;m)
    {
        b+=sum[L[v]]-sum[L[u]];
        b+=query(R[u],R[v],m+1,r,k);
    }
    else
        b+=query(L[u],L[v],l,m,k);
    return b;
}
int main()
{
    int T;
    scanf(&quot;%d&quot;,&amp;T);
    for(int j=1;j&lt;=T;j++)
    {
        tot=0;
        printf(&quot;Case %d:\n&quot;,j);
        scanf(&quot;%d%d&quot;,&amp;n,&amp;m);
        for(int i=1;i&lt;=n;i++)
        {
            scanf(&quot;%lld&quot;,&amp;a[i]);
            Hash[i]=a[i];
        }
        sort(Hash+1,Hash+1+n);
        int d=unique(Hash+1,Hash+1+n)-Hash-1;
        Hash[++d]=inf;
        t[0]=build(1,d);
        for(int i=1;i&lt;=n;i++)
        {
            int x=lower_bound(Hash+1,Hash+1+d,a[i])-Hash;
            t[i]=update(t[i-1],1,d,x);
        }
        for(int i=1;i&lt;=m;i++)
        {
            int l,r;
            long long h;
            scanf(&quot;%d%d%lld&quot;,&amp;l,&amp;r,&amp;h);
            l++;
            r++;
            int ans=0;
            int k=upper_bound(Hash+1,Hash+1+d,h)-Hash-1;
            if(k&gt;0)
                ans=query(t[l-1],t[r],1,d,k);
            printf(&quot;%d\n&quot;,ans);
        }
    }
    return 0;
}
</code></pre>
<h1 id="带修改（主席树-树状数组）"><a href="#带修改（主席树-树状数组）" class="headerlink" title="带修改（主席树+树状数组）"></a>带修改（主席树+树状数组）</h1><p><a href="https://www.luogu.org/problemnew/show/P2617" target="_blank" rel="noopener"> P2617 Dynamic Rankings</a></p>
<p>题意：n个数，q个询问 (n&lt;=50000, q&lt;=10000)</p>
<p>Q x y z 代表询问[x, y]区间里的第z小的数</p>
<p>C x y    代表将(从左往右数)第x个数变成y</p>
<p>上篇介绍了在[x, y]区间内查询第z小的数的方法(静态主席树)</p>
<p>本题有更新操作</p>
<p>若仍用上篇的做法，每次更新一个数，需要更新的是T[i], T[i+1]… …T<a href="该数所在的树以及它后面的所有树">n</a>，因为每棵树T[i]所记录的都是前缀(1到i的数出现的次数) 因此，改变i，会影响i到n的所有树</p>
<p>这样，每次更新的复杂度最坏为O(nn)，最坏更新q次即为O(n×mn×m) 复杂度相当庞大，很明显这样做是不行的</p>
<p>那怎么办呢？</p>
<p>我们可以发现，对于改变i处的数这个操作，对于T[i], T[i+1]… …T[n]这些树的影响是相同的，都只改变了  “原来i处的数 的数量”  和  “现在i处的数 的数量” 这两个值而已，我们只要在原来的基础上增加一类树， 用它们来维护更新掉的数，即用树状数组来记录更新，每次更新lognlogn棵树。</p>
<p>下面来演示一下建树到查询的过程：</p>
<p>比如此题的第一个案例</p>
<p>5 33 2 1 4 7</p>
<p>Q 1 4 3</p>
<p>C 2 6</p>
<p>Q 2 5 3</p>
<p>先将序列以及要更新的数(C操作)离散化  </p>
<p>即3 2 1 4 7 、 6  —-&gt;(排序) —-&gt; 1 2 3 4 6 7  </p>
<p>那么我们就需要建一棵这样的树：</p>
<p><img src="https://qqadapt.qpic.cn/txdocpic/0/f2402af8499c21a706cefa1d4f0a81b4/0" alt=""></p>
<p>(圈里的都是结点的编号， 4、5、6、9、10、11号结点代表的分别是1、2、3、4、6、7)</p>
<p>(4、5、9、10你也可以任意作为6或11的儿子， 递归生成的是类似这样的， 这并不重要)</p>
<p>对于3 2 1 4 7(先不管需要更新的6)建完树见下图(建树过程同静态的，不明白的请向上翻)</p>
<p><img src="https://qqadapt.qpic.cn/txdocpic/0/543df959260eef02bae09abae5a3d88a/0" alt=""></p>
<p>(红色的是个数， 相同结点的个数省略了，同前一棵树)</p>
<p>对于C操作之前的Q，就跟静态的类似，减一减 找就好了</p>
<p>然后下面要更新了</p>
<p>对于更新， 我们不改变这些已经建好的树， 而是另建一批树S，用来记录更新，而这批线段树，我们用树状数组来维护</p>
<p>也就是树状数组的每个节点都是一颗线段树</p>
<p>一开始，S[0]、S[1]、S[2]、S[3]、S[4]、S<a href="树状数组的每个节点">5</a>这些都与T[0]相同(也就是每个节点建了一棵空树)</p>
<p>对于C 2 6 这个操作， 我们只需要减去一个2，加上一个6即可</p>
<p>对于减去2</p>
<p>(树状数组i+lowbit(i)为i的父亲节点， 修改i，就要把i的所有父亲节点都修改了)</p>
<p>2在树状数组中出现的位置是 2、2+lowbit(2)=4 这两个位置，    </p>
<p>因此要更新的是S[2]和S[4]这两个节点中的树</p>
<p>删去2后是这样</p>
<p><img src="https://qqadapt.qpic.cn/txdocpic/0/e095409f1ad1dc184f7c2e530eb56dda/0" alt=""></p>
<p>加上一个6 (同样是对于2号位置， 因此需要更新的仍是S[2]和S[4])</p>
<p>加上之后是这样</p>
<p> <img src="https://qqadapt.qpic.cn/txdocpic/0/31b1e6754c984e4ae70179d0b02dacdd/0" alt=""></p>
<p> 当查询的时候， 对树T的操作与静态的一致，另外再加上S树的值就好了</p>
<p>教练的模板</p>
<pre><code class="cpp">#include &lt;iostream&gt;
#include &lt;algorithm&gt;
#include &lt;cstdlib&gt;
#include &lt;cstdio&gt;
#include &lt;cstring&gt;
#include &lt;cmath&gt;
#define N 60000+5//空间为nlogn*logn
using namespace std;

struct node
{
    int l;
    int r;
    int flag;
    int k;
}q[N];
int a[N],Hash[2*N],L[32*N],R[32*N],sum[32*N],s[32*N],T[32*N],n,m,dd,tot,use[32*N];
int lowbit(int x){return x&amp;(-x);}
int getsum(int x)
{
    int ret=0;
    while(x&gt;0)
    {
        ret+=sum[L[use[x]]];
        x-=lowbit(x);
    }
    return ret;
}
int build(int l,int r)
{
    int rt=++tot;
    int m=(l+r)/2;
    if(l&lt;r)
    {
        L[rt]=build(l,m);
        R[rt]=build(m+1,r);
    }
    return rt;
}
int update(int pre,int l,int r,int x,int d)
{
    int rt=++tot;
    L[rt]=L[pre];R[rt]=R[pre];sum[rt]=sum[pre]+d;
    if(l&lt;r)
    {
        int m=(l+r)/2;
        if(x&lt;=m)
            L[rt]=update(L[pre],l,m,x,d);
        else
            R[rt]=update(R[pre],m+1,r,x,d);
    }
    return rt;
}
int query(int u,int v,int ll,int rr,int l,int r,int k)
{
    if(l&gt;=r)return l;
    int m=(l+r)/2;
    int aa=getsum(v);
    int bb=getsum(u);
    int num=aa-bb+sum[L[rr]]-sum[L[ll]];
    if(k&lt;=num)
    {
        for(int j=u;j&gt;0;j=j-lowbit(j))use[j]=L[use[j]];
        for(int j=v;j&gt;0;j=j-lowbit(j))use[j]=L[use[j]];
        return query(u,v,L[ll],L[rr],l,m,k);
    }
    else
    {
        for(int j=u;j&gt;0;j=j-lowbit(j))use[j]=R[use[j]];
        for(int j=v;j&gt;0;j=j-lowbit(j))use[j]=R[use[j]];
        return query(u,v,R[ll],R[rr],m+1,r,k-num);
    }
}
void modify(int x,int p,int d)
{
    while(x&lt;=n)
    {
        s[x]=update(s[x],1,dd,p,d);
        x+=lowbit(x);
    }
}
int main()
{
    scanf(&quot;%d %d&quot;,&amp;n,&amp;m);
    int d=0;
    for(int i=1;i&lt;=n;i++)
    {
        scanf(&quot;%d&quot;,&amp;a[i]);
        Hash[++d]=a[i];
    }
    char ss[5];
    for(int i=1;i&lt;=m;i++)
    {
        scanf(&quot;%s&quot;,ss);
        if(ss[0]==&#39;Q&#39;)
        {
            scanf(&quot;%d%d%d&quot;,&amp;q[i].l,&amp;q[i].r,&amp;q[i].k);
            q[i].flag=1;
        }
        else
        {
            scanf(&quot;%d%d&quot;,&amp;q[i].l,&amp;q[i].r);
            Hash[++d]=q[i].r;
            q[i].flag=0;
        }
    }
    sort(Hash+1,Hash+1+d);
    dd=unique(Hash+1,Hash+1+d)-Hash-1;
    T[0]=build(1,dd);
    for(int i=1;i&lt;=n;i++)
    {
        int x=lower_bound(Hash+1,Hash+1+dd,a[i])-Hash;
        T[i]=update(T[i-1],1,dd,x,1);
    }
    for(int i=1;i&lt;=n;i++)s[i]=T[0];
    for(int i=1;i&lt;=m;i++)
    {
        if(q[i].flag)
        {
            for(int j=q[i].l-1;j&gt;0;j=j-lowbit(j))use[j]=s[j];
            for(int j=q[i].r;j&gt;0;j=j-lowbit(j))use[j]=s[j];
            int t=query(q[i].l-1,q[i].r,T[q[i].l-1],T[q[i].r],1,dd,q[i].k);
            printf(&quot;%d\n&quot;,Hash[t]);
        }
        else
        {
            int xx=lower_bound(Hash+1,Hash+1+dd,a[q[i].l])-Hash;
            int yy=lower_bound(Hash+1,Hash+1+dd,q[i].r)-Hash;
            modify(q[i].l,xx,-1);
            modify(q[i].l,yy,1);
            a[q[i].l]=q[i].r;
        }
    }
    return 0;
}
</code></pre>
<p>手写AC（对拍O2-96ms）</p>
<pre><code class="cpp">#include &lt;bits/stdc++.h&gt;
#define N 60010
using namespace std;
struct node
{
    int l,r,flag,k;
};struct node q[N];
int a[N],Hash[2*N],L[32*N],R[32*N],sum[32*N],s[32*N],T[32*N],n,m,dd,tot,use[32*N];
inline int lowbit(int x)
{
    return x&amp;(-x);
}
inline int getsum(int x)
{
    int ret=0;
    while(x&gt;0)
    {
        ret+=sum[L[use[x]]];
        x-=lowbit(x);
    }
    return ret;
}
inline int build(int l,int r)
{
    int rt=++tot;
    int m=(l+r)&gt;&gt;1;
    if(l&lt;r)
    {
        L[rt]=build(l,m);
        R[rt]=build(m+1,r);
    }
    return rt;
}
inline int update(int pre,int l,int r,int x,int d)
{
    int rt=++tot;
    L[rt]=L[pre];
    R[rt]=R[pre];
    sum[rt]=sum[pre]+d;
    if(l&lt;r)
    {
        int m=(l+r)&gt;&gt;1;
        if(x&lt;=m)
            L[rt]=update(L[pre],l,m,x,d);
        else
            R[rt]=update(R[pre],m+1,r,x,d);
    }
    return rt;
}
inline int query(int u,int v,int left,int right,int l,int r,int k)
{
    if(l&gt;=r)
        return l;
    int m=(l+r)&gt;&gt;1;
    int aa=getsum(v);
    int bb=getsum(u);
    int num=aa-bb+sum[L[right]]-sum[L[left]];
    if(k&lt;=num)
    {
        for(register int j=u;j&gt;0;j-=lowbit(j))
            use[j]=L[use[j]];
        for(register int j=v;j&gt;0;j-=lowbit(j))
            use[j]=L[use[j]];
        return query(u,v,L[left],L[right],l,m,k);
    }
    else
    {
        for(register int j=u;j&gt;0;j-=lowbit(j))
            use[j]=R[use[j]];
        for(register int j=v;j&gt;0;j-=lowbit(j))
            use[j]=R[use[j]];
        return query(u,v,R[left],R[right],m+1,r,k-num);
    }
}
inline void modify(int x,int p,int d)
{
    while (x&lt;=n)
    {
        s[x]=update(s[x],1,dd,p,d);
        x+=lowbit(x);
    }
}
int main()
{
    scanf(&quot;%d%d&quot;,&amp;n,&amp;m);
    int d=0;
    for(register int i=1;i&lt;=n;i++)
    {
        scanf(&quot;%d&quot;,&amp;a[i]);
        Hash[++d]=a[i];
    }
    char ss[5];
    for(register int i=1;i&lt;=m;i++)
    {
        scanf(&quot;%s&quot;,ss);
        if(ss[0]==&#39;Q&#39;)
        {
            scanf(&quot;%d%d%d&quot;,&amp;q[i].l,&amp;q[i].r,&amp;q[i].k);
            q[i].flag=1;
        }
        else
        {
            scanf(&quot;%d%d&quot;,&amp;q[i].l,&amp;q[i].r);
            Hash[++d]=q[i].r;
            q[i].flag=0;
        }
    }
    sort(Hash+1,Hash+1+d);
    dd=unique(Hash+1,Hash+1+d)-Hash-1;
    T[0]=build(1,dd);
    for(register int i=1;i&lt;=n;i++)
    {
        int x=lower_bound(Hash+1,Hash+1+dd,a[i])-Hash;
        T[i]=update(T[i-1],1,dd,x,1);
    }
    for(register int i=1;i&lt;=n;i++)
        s[i]=T[0];
    for(register int i=1;i&lt;=m;i++)
    {
        if(q[i].flag)
        {
            for(register int j=q[i].l-1;j&gt;0;j-=lowbit(j))
                use[j]=s[j];
            for(register int j=q[i].r;j&gt;0;j-=lowbit(j))
                use[j]=s[j];
            int t=query(q[i].l-1,q[i].r,T[q[i].l-1],T[q[i].r],1,dd,q[i].k);
            printf(&quot;%d\n&quot;,Hash[t]);
        }
        else
        {
            int xx=lower_bound(Hash+1,Hash+1+dd,a[q[i].l])-Hash;
            int yy=lower_bound(Hash+1,Hash+1+dd,q[i].r)-Hash;
            modify(q[i].l,xx,-1);
            modify(q[i].l,yy,1);
            a[q[i].l]=q[i].r;
        }
    }
    return 0;
}
</code></pre>
<h1 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h1><p><a href="https://www.luogu.org/problemnew/show/P1383" target="_blank" rel="noopener">P1383 高级打字机</a></p>
<p>手写AC</p>
<pre><code class="cpp">#include &lt;bits/stdc++.h&gt;
#define N 500010
using namespace std;
int a[N*32],L[32*N],R[32*N],sum[32*N],T[32*N],n,m,tot,cnt,use[32*N],root[32*N];
inline int Insert(int pre,int l,int r,int p,int x)
{
    int rt=++tot;
    if(l==r)
    {
        a[rt]=x;
        sum[rt]=sum[pre]+1;
        return rt;
    }
    L[rt]=L[pre];
    R[rt]=R[pre];
    sum[rt]=sum[pre]+1;
    int m=(l+r)&gt;&gt;1;
    if(p&lt;=m)
        L[rt]=Insert(L[pre],l,m,p,x);
    else
        R[rt]=Insert(R[pre],m+1,r,p,x);
    return rt;
}
inline int build(int l,int r)
{
    int rt=++tot;
    int m=(l+r)&gt;&gt;1;
    if(l&lt;r)
    {
        L[rt]=build(l,m);
        R[rt]=build(m+1,r);
    }
    return rt;
}
inline int query(int p,int l,int r,int x)
{
    if(l==r)
        return a[p];
    int m=(l+r)&gt;&gt;1;
    if(x&lt;=sum[L[p]])
        return query(L[p],l,m,x);
    else
        return query(R[p],m+1,r,x-sum[L[p]]);
}
int main()
{
    scanf(&quot;%d&quot;,&amp;n);
    root[0]=build(1,n);
    char ss[5];
    for(register int i=1;i&lt;=n;i++)
    {
        scanf(&quot;%s&quot;,ss);
        if(ss[0]==&#39;T&#39;)
        {
            char ch;
            scanf(&quot;%s&quot;,&amp;ch);
            int x=ch-&#39;a&#39;+1;
            root[++cnt]=Insert(root[cnt-1],1,n,i,x);
        }
        else if(ss[0]==&#39;U&#39;)
        {
            int x;
            scanf(&quot;%d&quot;,&amp;x);
            root[++cnt]=root[cnt-x-1];
        }
        else
        {
            int x;
            scanf(&quot;%d&quot;,&amp;x);
            char ch=query(root[cnt],1,n,x)+&#39;a&#39;-1;
            printf(&quot;%c\n&quot;,ch);
        }
    }
    return 0;
}
</code></pre>

        
    

    
</div>


                

                <!-- Post Comments -->
                
                    
                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2018/07/24/莫队/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2018/07/24/平衡树/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(http://b289.photo.store.qq.com/psb?/V137oTmC2F4y9l/oZNFIxX4ZCtS9FVnsdXcov2jp11l5N7T1gKXBgGhwbg!/c/dCEBAAAAAAAA&amp;bo=bAFsAWwBbAEBACc!);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="https://cdn.luogu.org/upload/usericon/55454.png" alt="DimensionTripper's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        kancolle233@yahoo.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="https://www.yahoo.com" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2018/07/">七月 2018<span class="sidebar_archives-count">18</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                分类
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/学习笔记/">学习笔记<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/categories/瞎jb搞/">瞎jb搞<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/categories/祭/">祭<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/题解/">题解<span class="sidebar_archives-count">8</span></a>
            </ul>
        </li>
        
    

    <!-- Pages  -->
    
        <li>
            <a href="/links" title="友情链接">
                
                    <i class="material-icons sidebar-material-icons">people</i>
                
                友情链接
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">18</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

    <a href="https://blog.viosey.com/index.php/Material.html" target="_blank" class="sidebar-footer-text-a">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
             sidebar.about_theme
            <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></div>
    </a>

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/twitter" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-twitter">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/facebook" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-facebook">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-gplus">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/DimensionTripper" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-github">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    
        <a href="https://space.bilibili.com/10850777/#/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-bilibili">
                <span class="visuallyhidden">Bilibili</span>
            </button><!--
     --></a>
    

    <!-- Telegram -->
    
    
    <!-- V2EX -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>DimensionTripper
            
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==", true)</script>



    <script>lsloader.load("js_js","/js/js.min.js?V/53wGualMuiPM3xoetD5Q==", true)</script>



    <script>lsloader.load("np_js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>













<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Import prettify js  -->

    
        
            <script>lsloader.load("prettify_js","/js/prettify.min.js?WN07fivHQSMKWy7BmHBB6w==", true)</script>
        
    



<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
        
            $(function() {
                $('pre').addClass('prettyprint linenums').attr('style', 'overflow:auto;');
                prettyPrint();
                })
        
    
    
</script>

<!-- MathJax Load-->


<!-- Bing Background -->


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->



<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.5.2 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
        </body>
    
</html>
